{# AIST: Waiting for deduplication â€” overall & per-test progress (finding-level). #}
{# This snippet expects: `pipeline` in context and URL name `dojo_aist:pipeline_progress`. #}

<div class="card mb-3">
  <div class="card-header">Deduplication progress (overall)</div>
  <div class="card-body">
    <div class="d-flex justify-content-between">
      <div>
        <span class="badge bg-info" id="overall-badge">0 / 0</span>
        <small class="text-muted ms-2" id="overall-remaining">(remaining: 0)</small>
      </div>
      <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
    </div>
    <div class="progress mt-3" style="height:18px;">
      <div id="overall-bar" class="progress-bar" role="progressbar" style="width:0%;" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <small class="text-muted d-block mt-2">
      This reflects deduplication at the <em>finding</em> level across all tests.
    </small>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header">Per-test deduplication</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-striped mb-0 align-middle">
        <thead>
          <tr>
            <th style="width: 120px;">Test</th>
            <th>Progress</th>
            <th style="width: 160px;" class="text-end">Processed / Total</th>
          </tr>
        </thead>
        <tbody id="tests-progress-body">
          {# Filled by JS #}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
/**
 * AIST: polling-based progress updater for deduplication stage.
 * - Polls JSON endpoint every 2.5s.
 * - Updates overall and per-test progress bars.
 * - Auto-reloads the page when status changes.
 */
(function () {
  const statusEl = document.getElementById("pl-status");
  let timer = null;

  function renderRows(tests) {
    const tbody = document.getElementById("tests-progress-body");
    if (!tbody) return;
    const rows = (tests || []).map(t => {
      const pct = Math.max(0, Math.min(100, parseInt(t.percent || 0)));
      const badge = `${t.processed || 0} / ${t.total_findings || 0}`;
      return `
        <tr>
          <td><span class="text-nowrap">${t.test_name || ("Test #" + t.test_id)}</span></td>
          <td>
            <div class="progress" style="height: 16px;">
              <div class="progress-bar ${t.completed ? 'bg-success' : ''}" role="progressbar"
                   style="width:${pct}%;" aria-valuemin="0" aria-valuemax="100">${pct}%</div>
            </div>
          </td>
          <td class="text-end"><span class="badge bg-secondary">${badge}</span></td>
        </tr>`;
    }).join("");
    tbody.innerHTML = rows || `<tr><td colspan="3" class="text-muted">No tests attached.</td></tr>`;
  }

  function renderOverall(overall) {
    const bar = document.getElementById("overall-bar");
    const badge = document.getElementById("overall-badge");
    const rem = document.getElementById("overall-remaining");
    if (!bar || !badge || !rem) return;

    const pct = Math.max(0, Math.min(100, parseInt(overall.percent || 0)));
    bar.style.width = pct + "%";
    bar.textContent = pct + "%";
    badge.textContent = (overall.processed || 0) + " / " + (overall.total_findings || 0);
    rem.textContent = "(remaining: " + (overall.pending || 0) + ")";
  }

  function poll() {
    fetch("{% url 'dojo_aist:pipeline_progress' pipeline.id %}")
      .then(r => r.json())
      .then(data => {
        renderOverall(data.overall || {});
        renderRows(data.tests || []);
        if (data.status && data.status !== "WAITING_DEDUPLICATION_TO_FINISH") {
          clearInterval(timer);
          timer = null;
          if (statusEl) statusEl.textContent = data.status;
          // Move to the next UI state automatically
          location.reload();
        }
      })
      .catch(() => {});
  }

  // Start polling when this partial is rendered
  poll();
  timer = setInterval(poll, 2500);
})();
</script>

{% extends 'base.html' %}
{% load i18n %}
{% block content %}
    <div class="container mt-3 pb-5">
        <div class="row g-4">

            <!-- Left panel: Start form -->
            <div class="col-12 col-lg-8">
                <h3 class="mb-3">Run SAST Pipeline</h3>
                <div class="card shadow-sm mb-5">
                    <div class="card-body pb-4">
                        <form method="post">
                            {% csrf_token %}
                            {{ form.selection_signature }}

                            {# Project select #}
                            <div class="mb-3 row">
                                <label class="col-sm-3 col-form-label">{{ form.project.label }}</label>
                                <div class="col-sm-9">
                                    {{ form.project }}
                                    {% if form.project.help_text %}
                                        <small class="form-text text-muted small">{{ form.project.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label class="col-sm-3 col-form-label">{{ form.project_version.label }}</label>
                                <div class="col-sm-9">
                                    {{ form.project_version }}
                                    {% if form.project_version.help_text %}
                                        <small class="form-text text-muted small">{{ form.project_version.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>

                            {# Rebuild images (checkbox) — aligned like other fields #}
                            <div class="mb-3 row">
                                <label class="col-sm-3 col-form-label">{{ form.ask_push_to_ai.label }}</label>
                                <div class="col-sm-9">
                                    <div class="form-check">
                                        {{ form.ask_push_to_ai }}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label class="col-sm-3 col-form-label">{{ form.rebuild_images.label }}</label>
                                <div class="col-sm-9">
                                    <div class="form-check">
                                        {{ form.rebuild_images }}
                                    </div>
                                </div>
                            </div>

                            {# Log level #}
                            <div class="mb-3 row">
                                <label class="col-sm-3 col-form-label">{{ form.log_level.label }}</label>
                                <div class="col-sm-9">
                                    {{ form.log_level }}
                                </div>
                            </div>

                            {# Languages as checkboxes #}
                            <div class="mb-3 row">
                                <label class="col-sm-3 col-form-label">{{ form.languages.label }}</label>
                                <div class="col-sm-9" id="languages-group">
                                    <div class="row">
                                        {% for checkbox in form.languages %}
                                            <div class="col-sm-6 col-lg-4">
                                                <div class="form-check mb-2">
                                                    {{ checkbox.tag }}
                                                    <label class="form-check-label">{{ checkbox.choice_label }}</label>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <small class="form-text text-muted small mt-1">
                                        Project-required languages are preselected and disabled.
                                    </small>
                                </div>
                            </div>

                            {# Analyzers as checkboxes #}
                            <div class="mb-3 row">
                                <label class="col-sm-3 col-form-label">{{ form.analyzers.label }}</label>
                                <div class="col-sm-9">
                                    <div class="row">
                                        {% for checkbox in form.analyzers %}
                                            <div class="col-sm-6 col-lg-4">
                                                <div class="form-check mb-2">
                                                    {{ checkbox.tag }}
                                                    <label class="form-check-label">{{ checkbox.choice_label }}</label>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            {# Time class #}
                            <div class="mb-3 row">
                                <label class="col-sm-3 col-form-label">{{ form.time_class_level.label }}</label>
                                <div class="col-sm-9">
                                    {{ form.time_class_level }}
                                </div>
                            </div>

                            <div class="text-end mt-3">
                                <button type="submit" class="btn btn-primary">Start</button>
                            </div>
                        </form>
                    </div>
                </div>

                {# hard spacer to guarantee bottom gap across themes #}
                <div class="mb-5"></div>
                <div style="height:48px"></div>
            </div>

            <!-- Right column: launch history -->
            <div class="col-12 col-lg-4">
                <div class="card shadow-sm sticky-lg-top" style="top: 76px;">
                    <div class="card-header d-flex align-items-center justify-content-between py-2 mb-2" style="margin-bottom:.5rem!important">
                        <span class="fw-semibold">Recent pipelines</span>
                        <span class="badge bg-secondary">{{ history_page.paginator.count }}</span>
                    </div>

                    <!-- Filter/search (GET) -->
                    <form method="get" class="mt-2 px-3 pb-0">
                        <div class="mb-2">
                            <label class="form-label small mb-1">Project</label>
                            <select class="form-select form-select-sm" name="project" onchange="this.form.submit()">
                                <option value="">All projects</option>
                                {% for p in form.fields.project.queryset %}
                                    <option value="{{ p.id }}"
                                            {% if selected_project|stringformat:"s" == p.id|stringformat:"s" %}selected{% endif %}>
                                        {{ p.product.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Search</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" name="q" value="{{ search_query }}"
                                       placeholder="ID or product name">
                                <button class="btn btn-outline-secondary btn-sm" type="submit">Apply</button>
                                <a class="btn btn-outline-light btn-sm border"
                                   href="{% url 'dojo_aist:start_pipeline' %}">Reset</a>
                            </div>
                        </div>
                        <input type="hidden" name="page_size" value="8">
                    </form>

                    {% if history_items %}
                        <div class="list-group list-group-flush mt-2">
                            {% for run in history_items %}
                                <a href="{% url 'dojo_aist:pipeline_detail' id=run.id %}"
                                   class="list-group-item list-group-item-action">
                                    <div class="d-flex justify-content-between">
                                        <div class="me-2">
                                            <div class="fw-semibold text-truncate"
                                                 title="{{ run.project_name }}">{{ run.project_name }}</div>
                                            <div class="text-muted small">#{{ run.id }}
                                                · {{ run.updated|date:"Y-m-d H:i" }}</div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-success">{{ run.status }}</span>
                                            {% if run.duration %}
                                                <div class="small mt-1">⏱ {{ run.duration }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>

                        <div class="card-footer d-flex align-items-center justify-content-between">
                            <div class="btn-group">
                                {% if history_page.has_previous %}
                                    <a class="btn btn-sm btn-outline-secondary"
                                       href="?{{ history_qs }}&page={{ history_page.previous_page_number }}">‹ Prev</a>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-secondary" disabled>‹ Prev</button>
                                {% endif %}
                                {% if history_page.has_next %}
                                    <a class="btn btn-sm btn-outline-secondary"
                                       href="?{{ history_qs }}&page={{ history_page.next_page_number }}">Next ›</a>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-secondary" disabled>Next ›</button>
                                {% endif %}
                            </div>
                            <div class="small text-muted">Page {{ history_page.number }}
                                / {{ history_page.paginator.num_pages }}</div>
                            <a class="btn btn-sm btn-outline-primary"
                               href="{% url 'dojo_aist:pipeline_list' %}?{{ history_qs }}">View all</a>
                        </div>
                    {% else %}
                        <div class="card-body text-muted">No finished runs yet.</div>
                    {% endif %}
                </div>
            </div>


        </div>
    </div>

    {# --- JS: auto-check/disable project languages + toggle project version visibility --- #}
    <script>
(function () {
  "use strict";

  /* run once */
  if (window.__AIST_BOOTED__) return;
  window.__AIST_BOOTED__ = true;

  /* helpers */
  function getCookie(name) {
    var value = "; " + document.cookie;
    var parts = value.split("; " + name + "=");
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
    return null;
  }
  function getCSRFToken(form) {
    return getCookie("csrftoken") ||
           (form.querySelector('input[name="csrfmiddlewaretoken"]') ? form.querySelector('input[name="csrfmiddlewaretoken"]').value : "");
  }
  function normalizeVersions(raw) {
    if (!raw) return [];
    if (Object.prototype.toString.call(raw) === "[object Array]") {
      var out = [];
      for (var i = 0; i < raw.length; i++) {
        var v = raw[i];
        if (v && typeof v === "object") {
          var id  = (v.id != null ? String(v.id) : (v.value != null ? String(v.value) : (v.slug != null ? String(v.slug) : String(v))));
          var lbl = (v.label != null ? String(v.label) : (v.name  != null ? String(v.name)  : (v.id    != null ? String(v.id)   : String(v))));
          out.push({ id: id, label: lbl });
        } else {
          out.push({ id: String(v), label: String(v) });
        }
      }
      return out;
    }
    if (typeof raw === "object") {
      var out2 = [];
      for (var k in raw) if (Object.prototype.hasOwnProperty.call(raw, k)) {
        var vv = raw[k];
        if (vv && typeof vv === "object") out2.push({ id: String(vv.id != null ? vv.id : k), label: String(vv.label != null ? vv.label : (vv.name != null ? vv.name : k)) });
        else out2.push({ id: String(k), label: String(vv) });
      }
      return out2;
    }
    return [{ id: String(raw), label: String(raw) }];
  }
  function prettifyLabel(label, projectId) {
    var pid = String(projectId || "");
    var s = String(label || "");
    var prefix = pid + ":";
    if (pid && s.indexOf(prefix) === 0) return s.slice(prefix.length);
    return s;
  }
  function hasSelectpicker() { return !!(window.jQuery && window.jQuery.fn && window.jQuery.fn.selectpicker); }
  function isSelectpickerApplied(el) {
    if (!hasSelectpicker() || !el) return false;
    var $ = window.jQuery;
    return !!($(el).data("selectpicker")) || ($(el).parent().hasClass("bootstrap-select"));
  }

  /* main */
  function main() {
    var form = document.querySelector('form[method="post"]');
    if (!form) return;

    var selProject = form.querySelector('select[name="{{ form.project.html_name }}"]');
    var selTime    = form.querySelector('select[name="{{ form.time_class_level.html_name }}"]');
    var selVersion = form.querySelector('select[name="{{ form.project_version.html_name }}"]');
    var langsWrap  = document.getElementById("languages-group");

    var DEFAULT_EMPTY_LABEL = "Use default (latest on default branch)";
    var metaUrlTemplate = "{% url 'dojo_aist:aist_project_meta' pk=0 %}";
    var defaultsUrl     = "{% url 'dojo_aist:aist_default_analyzers' %}";

    function languageCheckboxes() {
      return langsWrap ? langsWrap.querySelectorAll('input[name="{{ form.languages.html_name }}"]') : [];
    }
    function setLanguages(supported) {
      var fixed = {};
      if (supported && supported.length) for (var i = 0; i < supported.length; i++) fixed[supported[i]] = true;
      var boxes = languageCheckboxes();
      for (var j = 0; j < boxes.length; j++) {
        var cb = boxes[j];
        var isFixed = !!fixed[cb.value];
        cb.classList.add("form-check-input");
        var wrap = cb.closest ? cb.closest(".form-check") : null;
        var lbl  = wrap ? wrap.querySelector(".form-check-label") : null;
        if (isFixed) { cb.checked = true; cb.disabled = true; if (lbl) lbl.classList.add("text-muted"); }
        else { cb.disabled = false; cb.checked = false; if (lbl) lbl.classList.remove("text-muted"); }
      }
    }

    function rebuildProjectVersionSelect(versionsRaw, projectId) {
      if (!selVersion) return;

      if (document.activeElement === selVersion) {
        try { document.activeElement.blur(); } catch (e) {}
      }

      var list = normalizeVersions(versionsRaw);
      var usingPlugin = isSelectpickerApplied(selVersion);
      var $ = window.jQuery;

      if (usingPlugin) {
        try { $(selVersion).selectpicker("destroy"); } catch (e) {}

        while (selVersion.options.length) selVersion.remove(0);
        selVersion.setAttribute("title", DEFAULT_EMPTY_LABEL);
        selVersion.add(new Option(DEFAULT_EMPTY_LABEL, ""));
        for (var i = 0; i < list.length; i++) {
          selVersion.add(new Option(prettifyLabel(list[i].label, projectId), list[i].id));
        }

        var disabled = (list.length === 0);
        selVersion.disabled = disabled;

        $(selVersion).selectpicker();
        $(selVersion)
          .prop("disabled", disabled)
          .selectpicker("render")
          .selectpicker("refresh")
          .selectpicker("val", "");

        var $wrap = $(selVersion).closest(".bootstrap-select");
        if ($wrap.length) {
          $wrap.toggleClass("disabled", disabled);
          var $btn = $wrap.find("button");
          if ($btn.length) { $btn.prop("disabled", disabled).blur(); }
        }
      } else {
        selVersion.innerHTML = "";
        selVersion.add(new Option(DEFAULT_EMPTY_LABEL, ""));
        for (var k = 0; k < list.length; k++) {
          selVersion.add(new Option(prettifyLabel(list[k].label, projectId), list[k].id));
        }
        selVersion.disabled = (list.length === 0);
        setTimeout(function(){ try { selVersion.blur(); } catch(e){} }, 0);
      }

      var fs = selVersion.closest ? selVersion.closest("fieldset") : null;
      if (fs && fs.hasAttribute("disabled")) fs.removeAttribute("disabled");
    }

    function fetchProjectMeta(projectId, done) {
      if (!projectId) {
        setLanguages([]);
        rebuildProjectVersionSelect([], projectId);
        if (done) done();
        return;
      }
      var url = metaUrlTemplate.replace("/0/", "/" + String(projectId) + "/");
      fetch(url, { credentials: "same-origin" })
        .then(function (r) {
          if (!r.ok) return r.text().then(function(){ throw new Error("HTTP " + r.status); });
          return r.json();
        })
        .then(function (data) {
          setLanguages(data && data.supported_languages ? data.supported_languages : []);
          rebuildProjectVersionSelect(data && data.versions ? data.versions : [], projectId);
          if (done) done();
        })
        .catch(function () {
          setLanguages([]);
          rebuildProjectVersionSelect([], projectId);
          if (done) done();
        });
    }

    function collectAndRefreshAnalyzers() {
      if (!defaultsUrl) return Promise.resolve();
      var fd = new FormData();
      fd.append("project", selProject ? selProject.value : "");
      fd.append("time_class_level", selTime ? selTime.value : "");
      var boxes = languageCheckboxes();
      for (var i = 0; i < boxes.length; i++) if (boxes[i].checked) fd.append("languages", boxes[i].value);

      var csrf = getCSRFToken(form);

      return fetch(defaultsUrl, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "X-CSRFToken": csrf,
          "X-Requested-With": "XMLHttpRequest",
          "Accept": "application/json"
        },
        body: fd
      })
      .then(function (r) {
        if (!r.ok) return r.text().then(function(){ throw new Error("HTTP " + r.status); });
        return r.json();
      })
      .then(function (data) {
        var sig = form.querySelector('input[name="{{ form.selection_signature.html_name }}"]');
        if (sig && data && data.signature) sig.value = data.signature;

        var wanted = {};
        if (data && data.defaults && data.defaults.length) {
          for (var j = 0; j < data.defaults.length; j++) wanted[data.defaults[j]] = true;
        }
        var analyzerBoxes = form.querySelectorAll('input[name="{{ form.analyzers.html_name }}"]');
        for (var k = 0; k < analyzerBoxes.length; k++) {
          analyzerBoxes[k].checked = !!wanted[analyzerBoxes[k].value];
        }
      })
      .catch(function () { /* silent */ });
    }

    function onProjectChanged() {
      fetchProjectMeta(selProject ? selProject.value : "", function () {
        collectAndRefreshAnalyzers();
      });
    }

    if (selProject) {
      selProject.addEventListener("change", onProjectChanged);
      if (hasSelectpicker()) {
        try { window.jQuery(selProject).off("changed.bs.select.aist").on("changed.bs.select.aist", onProjectChanged); } catch (e) {}
      }
    }
    if (selTime) {
      selTime.addEventListener("change", collectAndRefreshAnalyzers);
      if (hasSelectpicker()) {
        try { window.jQuery(selTime).off("changed.bs.select.aist").on("changed.bs.select.aist", collectAndRefreshAnalyzers); } catch (e) {}
      }
    }
    var boxes = languageCheckboxes();
    for (var q = 0; q < boxes.length; q++) boxes[q].addEventListener("change", collectAndRefreshAnalyzers);

    if (selProject && selProject.value) {
      fetchProjectMeta(selProject.value, function(){ collectAndRefreshAnalyzers(); });
    } else {
      setLanguages([]);
      rebuildProjectVersionSelect([], selProject ? selProject.value : "");
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", main);
  } else {
    main();
  }
})();
</script>

{% endblock %}
